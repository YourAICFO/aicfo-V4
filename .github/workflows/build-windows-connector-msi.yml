# Windows Connector: validate Tray build and produce portable ZIP. MSI is built locally (build-release-local.ps1).
name: Windows Connector Validate (No MSI)

on:
  push:
    branches: [ main ]
    paths:
      - "connector-dotnet/**"
      - ".github/workflows/build-windows-connector-msi.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "connector-dotnet/**"
      - ".github/workflows/build-windows-connector-msi.yml"
  workflow_dispatch:
    inputs:
      build_msi:
        description: "Run full MSI build (WiX). Default false; MSI is normally built locally."
        required: false
        default: false
        type: boolean

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Build Tray (Release)
        shell: pwsh
        run: |
          dotnet build ./connector-dotnet/AICFO.Connector.Tray/AICFO.Connector.Tray.csproj -c Release

      - name: Publish Tray (win-x64, self-contained)
        shell: pwsh
        run: |
          $out = "connector-dotnet/out/publish"
          if (Test-Path $out) { Remove-Item -Recurse -Force $out }
          dotnet publish ./connector-dotnet/AICFO.Connector.Tray/AICFO.Connector.Tray.csproj `
            -c Release -r win-x64 --self-contained true -o $out `
            /p:PublishSingleFile=true /p:SelfContained=true `
            /p:IncludeNativeLibrariesForSelfExtract=true /p:PublishTrimmed=false
          if (-not (Test-Path "$out/AICFO.Connector.Tray.exe")) { throw "Publish failed: Tray exe not found" }
          Write-Host "Tray published to $out"

      - name: Verify Tray (optional)
        shell: pwsh
        run: |
          .\connector-dotnet\verify-tray.ps1
        continue-on-error: true

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $zipDir = "connector-dotnet/out/release"
          if (-not (Test-Path $zipDir)) { New-Item -ItemType Directory -Path $zipDir -Force | Out-Null }
          $zipPath = "$zipDir/AICFO-Connector-Portable-win-x64.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path "connector-dotnet/out/publish/*" -DestinationPath $zipPath -Force
          Write-Host "Created $zipPath"
          Get-Item $zipPath | Select-Object FullName, Length

      - name: Upload portable artifact
        uses: actions/upload-artifact@v4
        with:
          name: "AICFO-Connector-Portable-win-x64"
          path: "connector-dotnet/out/release/AICFO-Connector-Portable-win-x64.zip"

  # MSI build only when explicitly requested via workflow_dispatch (build_msi = true). Not run on push/PR.
  build-msi:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.build_msi == 'true'
    runs-on: windows-latest
    env:
      TIMESTAMP_URL: "http://timestamp.digicert.com"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install WiX v4 tool
        shell: pwsh
        run: dotnet tool install --global wix --version 4.*

      - name: Restore installer project
        shell: pwsh
        run: dotnet restore ./connector-dotnet/installer/AICFO.Connector.Installer.wixproj

      - name: Build connector MSI
        shell: pwsh
        run: ./connector-dotnet/build.ps1 -Configuration Release

      - name: Locate MSI
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path connector-dotnet -Recurse -Filter AICFOConnectorSetup.msi -File | Select-Object -First 1
          if (-not $msi) { throw "AICFOConnectorSetup.msi not found after build." }
          Write-Host "MSI at $($msi.FullName)"

      - name: Sign binaries and MSI (optional)
        id: sign
        env:
          CODESIGN_PFX_BASE64: ${{ secrets.CODESIGN_PFX_BASE64 }}
          CODESIGN_PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          if ([string]::IsNullOrWhiteSpace($env:CODESIGN_PFX_BASE64) -or [string]::IsNullOrWhiteSpace($env:CODESIGN_PFX_PASSWORD)) {
            Write-Host "Signing secrets not set; skipping sign step."
            "signed=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }
          $pfxPath = Join-Path $env:RUNNER_TEMP "codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:CODESIGN_PFX_BASE64))
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter "signtool.exe" -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
          if (-not $signtool) { $signtool = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"; if (-not (Test-Path $signtool)) { throw "signtool not found" } }
          $ts = $env:TIMESTAMP_URL
          $sign = { param($f) & $signtool sign /tr $ts /td sha256 /fd sha256 /f $pfxPath /p $env:CODESIGN_PFX_PASSWORD $f }
          & $sign "connector-dotnet\publish\service\AICFO.Connector.Service.exe"
          & $sign "connector-dotnet\publish\tray\AICFO.Connector.Tray.exe"
          $msiPath = Get-ChildItem -Path connector-dotnet -Recurse -Filter AICFOConnectorSetup.msi -File | Select-Object -First 1 -ExpandProperty FullName
          & $sign $msiPath
          Remove-Item $pfxPath -Force -ErrorAction SilentlyContinue
          "signed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Copy MSI to out
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path connector-dotnet -Recurse -Filter AICFOConnectorSetup.msi -File | Select-Object -First 1
          $outDir = "connector-dotnet/out"
          if (-not (Test-Path $outDir)) { New-Item -ItemType Directory -Path $outDir -Force | Out-Null }
          Copy-Item -Path $msi.FullName -Destination "$outDir/AICFOConnectorSetup.msi" -Force

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: "AICFOConnectorSetup.msi"
          path: "connector-dotnet/out/AICFOConnectorSetup.msi"
