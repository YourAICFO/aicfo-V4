<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package Name="AI CFO Connector"
           Manufacturer="AI CFO"
           Version="1.0.0"
           UpgradeCode="f72aaf9d-f8cf-49de-b380-89df3af861bf"
           Language="1033">

    <MajorUpgrade DowngradeErrorMessage="A newer version of AI CFO Connector is already installed." />
    <MediaTemplate EmbedCab="yes" />
    <ui:WixUI Id="WixUI_Minimal" />

    <!-- Installer UX: default ON. WixUI checkbox can toggle this at install time. -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Start AICFO Connector at login" />

    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="AICFOConnector">
        <Directory Id="SERVICEFOLDER" Name="Service" />
        <Directory Id="TRAYFOLDER" Name="Tray" />
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="AICFOProgramMenuFolder" Name="AI CFO Connector" />
    </StandardDirectory>

    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="ProgramDataAICFO" Name="AICFO">
        <Directory Id="ProgramDataConfig" Name="config" />
        <Directory Id="ProgramDataLogs" Name="logs" />
      </Directory>
    </StandardDirectory>

    <Component Id="ConnectorServiceExeComponent" Directory="SERVICEFOLDER">
      <File Id="ServiceExe" Source="$(var.ServicePublishDir)\AICFO.Connector.Service.exe" />
      <ServiceInstall Id="ConnectorServiceInstall"
                      Name="AICFO Connector Service"
                      DisplayName="AICFO Connector Service"
                      Description="Syncs Tally accounting data to AI CFO backend"
                      Type="ownProcess"
                      Start="auto"
                      ErrorControl="normal"
                      Account="LocalSystem" />
      <ServiceControl Id="ConnectorServiceControl"
                      Name="AICFO Connector Service"
                      Start="install"
                      Stop="both"
                      Remove="uninstall"
                      Wait="yes" />
    </Component>

    <Component Id="ConnectorTrayExeComponent" Directory="TRAYFOLDER" Guid="{3C4E16A1-6D99-4C93-9D97-EBC6E2DB4C58}">
      <File Id="TrayExe" Source="$(var.TrayPublishDir)\AICFO.Connector.Tray.exe" />
    </Component>

    <Component Id="ConnectorTrayStartMenuShortcut" Directory="AICFOProgramMenuFolder" Guid="{7FE2E546-D662-4BCA-9E07-E5FD240B8BCF}">
      <RegistryValue Root="HKCU" Key="Software\AICFO\Connector" Name="TrayStartMenuShortcut" Type="integer" Value="1" KeyPath="yes" />
      <Shortcut Id="AicfoTrayStartMenu"
                Name="AI CFO Connector"
                Description="Open AI CFO Connector Control Panel"
                Target="[TRAYFOLDER]AICFO.Connector.Tray.exe"
                WorkingDirectory="TRAYFOLDER" />
      <RemoveFolder Id="RemoveAICFOProgramMenuFolder" Directory="AICFOProgramMenuFolder" On="uninstall" />
    </Component>

    <Component Id="ConnectorTrayDesktopShortcut" Directory="DesktopFolder" Guid="{FAED13D9-532D-4A74-876B-38A22C274DDC}">
      <RegistryValue Root="HKCU" Key="Software\AICFO\Connector" Name="TrayDesktopShortcut" Type="integer" Value="1" KeyPath="yes" />
      <Shortcut Id="AicfoTrayDesktop"
                Name="AI CFO Connector"
                Description="Open AI CFO Connector Control Panel"
                Target="[TRAYFOLDER]AICFO.Connector.Tray.exe"
                WorkingDirectory="TRAYFOLDER" />
    </Component>

    <!-- Per-user auto-start registry component is isolated from file/shortcut components to avoid ICE43/ICE57. -->
    <Component Id="ConnectorTrayAutoStartRunKey"
               Directory="INSTALLFOLDER"
               Guid="{C9DF700D-0E55-4D45-BA0E-B8FE1C9D47D2}"
               Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1">
      <RegistryValue Root="HKCU" Key="Software\AICFO\Connector" Name="TrayAutoStart" Type="integer" Value="1" KeyPath="yes" />
      <RegistryValue Root="HKCU"
                     Key="Software\Microsoft\Windows\CurrentVersion\Run"
                     Name="AICFOConnectorTray"
                     Type="string"
                     Value="&quot;[TRAYFOLDER]AICFO.Connector.Tray.exe&quot;" />
    </Component>

    <Component Id="ProgramDataConfigFolderComponent" Directory="ProgramDataConfig" Guid="{1E92F7D1-5F14-4E48-8C2B-2A9582CE1AF0}">
      <CreateFolder />
    </Component>

    <Component Id="ProgramDataLogsFolderComponent" Directory="ProgramDataLogs" Guid="{2A0E6B95-4E3E-4EE5-8CC0-0F4A091A3E7B}">
      <CreateFolder />
    </Component>

    <Feature Id="MainFeature" Title="AI CFO Connector" Level="1">
      <ComponentRef Id="ConnectorServiceExeComponent" />
      <ComponentRef Id="ConnectorTrayExeComponent" />
      <ComponentRef Id="ConnectorTrayStartMenuShortcut" />
      <ComponentRef Id="ConnectorTrayDesktopShortcut" />
      <ComponentRef Id="ConnectorTrayAutoStartRunKey" />
      <ComponentRef Id="ProgramDataConfigFolderComponent" />
      <ComponentRef Id="ProgramDataLogsFolderComponent" />
      <ComponentGroupRef Id="ServicePublishFiles" />
      <ComponentGroupRef Id="TrayPublishFiles" />
    </Feature>
  </Package>
</Wix>
